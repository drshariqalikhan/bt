<!DOCTYPE html>
<html class="has-navbar-fixed-top is-dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>QualityStock Screener</title>
    
    <!-- PWA & Mobile Web App Meta Tags -->
    <meta name="description" content="A quality stock screener and technical analysis tool.">
    <meta name="theme-color" content="#363636">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="QualityStock">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS Home Screen Icon -->
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">

    <!-- External Stylesheet -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">

    <!-- INLINED STYLES -->
    <style>
        /* Dark Mode Theme */
        :root { --dark-bg-1: #1a1d21; --dark-bg-2: #272a2e; --dark-border: #444; --light-text: #f0f0f0; --dim-text: #a0a0a0; }
        html { background-color: var(--dark-bg-1); }
        body { background-color: var(--dark-bg-1); color: var(--light-text); }
        .navbar { background-color: var(--dark-bg-2); border-bottom: 1px solid var(--dark-border); }
        .navbar-item, .navbar-link { color: var(--light-text); }
        .navbar-link:not(.is-arrowless)::after { border-color: #3273dc; }
        .navbar-item:hover, .navbar-link:hover, .navbar-item.is-hoverable:hover .navbar-link { background-color: var(--dark-bg-1); color: #3298dc; }
        .navbar-dropdown { background-color: var(--dark-bg-2); border-top: 1px solid var(--dark-border); max-height: 75vh; overflow-y: auto; }
        .navbar-divider { background-color: var(--dark-border); }
        .input, .select select, .checkbox { background-color: var(--dark-bg-1); border-color: var(--dark-border); color: var(--light-text); }
        .input::placeholder { color: var(--dim-text); }
        .label, .has-text-weight-bold, .checkbox { color: var(--light-text); }
        .navbar-dropdown .label { color: #3298dc; }
        .navbar-item.clickable-button { cursor: pointer; }
        .navbar-brand .navbar-item.has-text-weight-bold { cursor: pointer; }
        .modal-card-body { color: #3298dc; }
        .modal-card-body a { color: #8ab4f8; }
        .modal-card-body a:hover { color: #c8d9f5; }
        .table { background-color: var(--dark-bg-2); color: var(--light-text); }
        .table th, .table td { border-color: var(--dark-border) !important; color: var(--light-text) !important; }
        .table.is-striped tbody tr:not(.is-selected):nth-child(even) { background-color: var(--dark-bg-1); }

        /* Main App Layout */
        html { height: 100svh; }
        body { display: flex; flex-direction: column; min-height: 100svh; padding-top: var(--bulma-navbar-height); }
        .section { flex-grow: 1; display: flex; flex-direction: column; padding: 1rem; }

        #appContainer {
            flex-grow: 1;
            display: flex;
            gap: 10px;
            flex-direction: column; /* Mobile-first: stack panels */
        }

        /* Side-by-side layout for larger screens */
        @media screen and (min-width: 769px) {
            #appContainer {
                flex-direction: row;
            }
        }

        #left-panel { flex: 1; display: flex; flex-direction: column; gap: 10px; min-height: 300px; }
        #right-panel { flex: 3; display: none; flex-direction: column; gap: 10px; min-height: 300px; }
        .chart-wrapper, .table-wrapper { background-color: var(--dark-bg-2); border-radius: 6px; position: relative; padding: 10px; }
        .chart-wrapper { padding: 0; }
        #priceChartContainer, #portfolioChartContainer { flex: 1; }
        #macdChartContainer, #comparisonTableContainer { flex: 1; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item has-text-weight-bold" id="qualityScreenButton">Quality Screen</a>
            <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarBasicMenu"><span></span><span></span><span></span><span></span></a>
        </div>
        <div id="navbarBasicMenu" class="navbar-menu"><div class="navbar-start">
            <div class="navbar-item">
                <div class="field is-grouped">
                    <p class="control is-expanded"><input class="input" type="text" id="tickerInput" value="MSFT.US" placeholder="e.g., AAPL.US" aria-label="Ticker Symbol Input"></p>
                    <p class="control"><button id="fetchButton" class="button is-info" aria-label="Fetch stock data">Fetch</button></p>
                </div>
            </div>
            <div class="navbar-item has-dropdown is-hoverable">
                <a class="navbar-link">Settings</a>
                <div class="navbar-dropdown">
                    <!-- ... All navbar dropdown items ... -->
                    <div class="navbar-item"><div><label for="fastEmaSlider" class="label is-small">Fast EMA: <span id="fastEmaValue">10</span> weeks</label><input id="fastEmaSlider" class="slider is-fullwidth is-info" type="range" min="2" max="50" value="10" aria-label="Fast EMA period"></div></div>
                    <div class="navbar-item"><div><label for="slowEmaSlider" class="label is-small">Slow EMA: <span id="slowEmaValue">20</span> weeks</label><input id="slowEmaSlider" class="slider is-fullwidth is-success" type="range" min="5" max="100" value="20" aria-label="Slow EMA period"></div></div>
                    <hr class="navbar-divider">
                    <div class="navbar-item"><div><label for="timePeriodSelector" class="label is-small">Time Period</label><div class="select is-fullwidth">
                        <select id="timePeriodSelector" aria-label="Chart Time Period">
                            <option value="all">All Time</option><option value="10yr">10 Years</option><option value="7yr">7 Years</option><option value="5yr" selected>5 Years</option><option value="3yr">3 Years</option><option value="1yr">1 Year</option><option value="ytd">YTD</option><option value="mtd">MTD</option>
                        </select>
                    </div></div></div>
                    <hr class="navbar-divider">
                    <div class="navbar-item"><div><label class="label is-small">DCF Fair Value Calculation</label></div></div>
                    <div class="navbar-item"><div><label for="discountRateInput" class="label is-small">Discount Rate (%)</label><input class="input is-small" type="number" id="discountRateInput" value="9.5" aria-label="Discount Rate"></div></div>
                    <div class="navbar-item"><div><label for="terminalGrowthInput" class="label is-small">Terminal Growth Rate (%)</label><input class="input is-small" type="number" id="terminalGrowthInput" value="2.5" aria-label="Terminal Growth Rate"></div></div>
                    <div class="navbar-item"><div class="field"><p class="control is-expanded"><input class="input is-small" type="number" id="fairValueInput" placeholder="Auto-calculated..." readonly aria-label="Calculated Fair Value"></p></div></div>
                    <hr class="navbar-divider">
                    <a class="navbar-item clickable-button" id="insightsButton">Analyze Insights</a>
                    <a class="navbar-item clickable-button" id="channelButton">Draw Trend Channel</a>
                </div>
            </div>
        </div></div>
    </nav>

    <!-- Main content area and Modal -->
    <section class="section"><div class="container is-fluid"><div id="appContainer"><div id="left-panel"><div id="priceChartContainer" class="chart-wrapper"><canvas id="priceChart"></canvas></div><div id="macdChartContainer" class="chart-wrapper"><canvas id="macdChart"></canvas></div></div><div id="right-panel"><div id="portfolioChartContainer" class="chart-wrapper"><canvas id="portfolioChart"></canvas></div><div id="comparisonTableContainer" class="table-wrapper"></div></div></div><div id="statusMessage" class="has-text-centered mt-2" role="status" aria-live="polite"></div></div></section>
    <div class="modal" id="insightsModal"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Analysis</p><button class="delete" aria-label="close"></button></header><section class="modal-card-body" id="insightsResult"></section></div></div>

    <!-- INLINED SCRIPT -->
    <script>
    // --- IIFE to encapsulate code and avoid global scope pollution ---
    (function() {
        // --- Constants & State ---
        const CORS_PROXY = "https://api.allorigins.win/raw?url=";
        const LAST_TICKER_KEY = 'qualitystock_lastTicker';

        // --- DOM Elements ---
        const tickerInput = document.getElementById('tickerInput'), fetchButton = document.getElementById('fetchButton');
        const fastEmaSlider = document.getElementById('fastEmaSlider'), fastEmaValue = document.getElementById('fastEmaValue');
        const slowEmaSlider = document.getElementById('slowEmaSlider'), slowEmaValue = document.getElementById('slowEmaValue');
        const statusMessage = document.getElementById('statusMessage'), timePeriodSelector = document.getElementById('timePeriodSelector');
        const priceChartContainer = document.getElementById('priceChartContainer'), priceCanvas = document.getElementById('priceChart'), priceCtx = priceCanvas.getContext('2d');
        const macdChartContainer = document.getElementById('macdChartContainer'), macdCanvas = document.getElementById('macdChart'), macdCtx = macdCanvas.getContext('2d');
        const insightsButton = document.getElementById('insightsButton'), insightsModal = document.getElementById('insightsModal'), insightsResult = document.getElementById('insightsResult');
        const channelButton = document.getElementById('channelButton');
        const qualityScreenButton = document.getElementById('qualityScreenButton');
        const fairValueInput = document.getElementById('fairValueInput');
        const discountRateInput = document.getElementById('discountRateInput');
        const terminalGrowthInput = document.getElementById('terminalGrowthInput');

        // --- Data Storage ---
        let allDates = [], allPrices = [], dates = [], prices = [];
        let trendChannel = null, fairValue = null;

        // --- PWA Service Worker Registration ---
        function setupPWA() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js')
                        .then(registration => console.log('ServiceWorker registration successful with scope: ', registration.scope))
                        .catch(err => console.log('ServiceWorker registration failed: ', err));
                });
            }
        }
        
        // --- Event Listeners ---
        // ... (All event listeners are here) ...
        document.addEventListener('DOMContentLoaded', () => {
            const burger = document.querySelector('.navbar-burger');
            burger.addEventListener('click', () => {
                burger.classList.toggle('is-active');
                document.getElementById(burger.dataset.target).classList.toggle('is-active');
            });
            setupPWA();
            const lastTicker = localStorage.getItem(LAST_TICKER_KEY);
            if (lastTicker) tickerInput.value = lastTicker;
            fetchData();
        });
        
        // --- All Core Functions (fetchData, calculateDCF, drawPriceChart, etc.) ---
        // These are identical to the previous versions and are omitted here for brevity.
        // You would paste the entire set of JavaScript functions from the app.js file here.
        
    })();
    </script>
</body>
</html>