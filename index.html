<!DOCTYPE html>
<html class="has-navbar-fixed-top is-dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>QualityStock Screener</title>
    
    <meta name="description" content="A quality stock screener and technical analysis tool.">
    <meta name="theme-color" content="#363636">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="QualityStock">

    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">

    <style>
        /* Base Theme */
        :root { --dark-bg-1: #1a1d21; --dark-bg-2: #272a2e; --dark-border: #444; --light-text: #f0f0f0; --dim-text: #a0a0a0; }
        html { background-color: var(--dark-bg-1); }
        body { background-color: var(--dark-bg-1); color: var(--light-text); }
        .navbar { background-color: var(--dark-bg-2); border-bottom: 1px solid var(--dark-border); }
        .navbar-item, .navbar-link { color: var(--light-text); }
        .navbar-link:not(.is-arrowless)::after { border-color: #3273dc; }
        .navbar-item:hover, .navbar-link:hover, .navbar-item.is-active { background-color: var(--dark-bg-1) !important; color: #3298dc !important; }
        .navbar-dropdown { background-color: var(--dark-bg-2); border-top: 1px solid var(--dark-border); max-height: 75vh; overflow-y: auto; }
        .navbar-divider { background-color: var(--dark-border); }
        .input, .select select, .checkbox { background-color: var(--dark-bg-1); border-color: var(--dark-border); color: var(--light-text); }
        .input::placeholder { color: var(--dim-text); }
        .label, .has-text-weight-bold, .checkbox { color: var(--light-text); }
        .navbar-dropdown .label { color: #3298dc; }
        .navbar-item.clickable-button { cursor: pointer; }
        .navbar-brand .navbar-item.has-text-weight-bold { cursor: pointer; }
        .modal-card-body { color: #3298dc; }
        .modal-card-body a { color: #8ab4f8; }
        .modal-card-body a:hover { color: #c8d9f5; }
        .table { background-color: var(--dark-bg-2); color: var(--light-text); }
        .table th, .table td { border-color: var(--dark-border) !important; color: var(--light-text) !important; }
        .table.is-striped tbody tr:not(.is-selected):nth-child(even) { background-color: var(--dark-bg-1); }

        /* Main App Layout */
        html { height: 100svh; }
        body { display: flex; flex-direction: column; min-height: 100svh; padding-top: calc(var(--bulma-navbar-height) + env(safe-area-inset-top)); }
        .navbar.is-fixed-top { padding-top: env(safe-area-inset-top); padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right); }
        .section { flex-grow: 1; display: flex; flex-direction: column; padding: 1rem; height: 1px; padding-bottom: calc(1rem + env(safe-area-inset-bottom)); }
        #appContainer { flex-grow: 1; display: flex; gap: 10px; flex-direction: column; }
        @media screen and (min-width: 769px) { #appContainer { flex-direction: row; } }
        #left-panel { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        #right-panel { flex: 3; display: none; flex-direction: column; gap: 10px; }
        .chart-wrapper, .table-wrapper { background-color: var(--dark-bg-2); border-radius: 6px; position: relative; }
        #left-panel .chart-wrapper { flex: 1 1 0; min-height: 0; }
        .chart-wrapper { padding: 0; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        /* --- CUSTOM PICKER STYLES --- */
        .picker-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: flex-end; z-index: 100; }
        .picker-modal.is-active { display: flex; }
        .picker-card { background-color: var(--dark-bg-2); width: 100%; max-width: 500px; border-top-left-radius: 12px; border-top-right-radius: 12px; }
        .picker-header { display: flex; justify-content: space-between; padding: 10px 15px; border-bottom: 1px solid var(--dark-border); }
        .picker-header button { background: none; border: none; color: #3298dc; font-size: 1rem; cursor: pointer; }
        .picker-content { display: flex; padding: 20px 0; height: 240px; position: relative; }
        .picker-wheels { display: flex; flex-grow: 1; overflow: hidden; }
        .picker-wheel { flex: 1; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch; }
        .picker-wheel::-webkit-scrollbar { display: none; } /* Hide scrollbar */
        .picker-item { height: 44px; display: flex; justify-content: center; align-items: center; scroll-snap-align: center; color: var(--light-text); font-size: 1.2rem; }
        .picker-selection-indicator { position: absolute; top: 50%; left: 0; right: 0; height: 44px; margin-top: -22px; border-top: 1px solid var(--dark-border); border-bottom: 1px solid var(--dark-border); pointer-events: none; }

        /* Make readonly inputs look clickable */
        input[readonly] { cursor: pointer; }

    </style>
</head>
<body>

    <nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item has-text-weight-bold" id="qualityScreenButton">Quality Screen</a>
            <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarBasicMenu"><span></span><span></span><span></span><span></span></a>
        </div>
        <div id="navbarBasicMenu" class="navbar-menu">
            <div class="navbar-start">
                <div class="navbar-item">
                    <div class="field is-grouped">
                        <p class="control is-expanded"><input class="input" type="text" id="tickerInput" value="MSFT.US" placeholder="Select a Ticker..." aria-label="Ticker Symbol Input" readonly></p>
                        <p class="control"><button id="fetchButton" class="button is-info" aria-label="Fetch stock data">Fetch</button></p>
                    </div>
                </div>
                <div class="navbar-item has-dropdown" id="settingsDropdown">
                    <a class="navbar-link">Settings</a>
                    <div class="navbar-dropdown">
                        <div class="navbar-item"><div><label for="discountRateInput" class="label is-small">Discount Rate (%)</label><input class="input is-small" type="text" id="discountRateInput" value="9.50" aria-label="Discount Rate" readonly></div></div>
                        <div class="navbar-item"><div><label for="terminalGrowthInput" class="label is-small">Terminal Growth Rate (%)</label><input class="input is-small" type="text" id="terminalGrowthInput" value="2.50" aria-label="Terminal Growth Rate" readonly></div></div>
                        <hr class="navbar-divider">
                        <div class="navbar-item"><div><label for="timePeriodSelector" class="label is-small">Time Period</label><div class="select is-fullwidth"><select id="timePeriodSelector"><option value="all">All Time</option><option value="10yr">10 Years</option><option value="7yr">7 Years</option><option value="5yr" selected>5 Years</option><option value="3yr">3 Years</option><option value="1yr">1 Year</option></select></div></div></div>
                        <hr class="navbar-divider">
                        <div class="navbar-item"><div><label for="fairValueInput" class="label is-small">DCF Fair Value</label><input class="input is-small" type="text" id="fairValueInput" placeholder="Auto-calculated..." readonly></div></div>
                        <hr class="navbar-divider">
                        <a class="navbar-item clickable-button" id="insightsButton">Analyze Insights</a>
                        <a class="navbar-item clickable-button" id="channelButton">Draw Trend Channel</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <section class="section">
        <div id="appContainer">
            <div id="left-panel"><div id="priceChartContainer" class="chart-wrapper"><canvas id="priceChart"></canvas></div><div id="macdChartContainer" class="chart-wrapper"><canvas id="macdChart"></canvas></div></div>
            <div id="right-panel"><div id="portfolioChartContainer" class="chart-wrapper"><canvas id="portfolioChart"></canvas></div><div id="comparisonTableContainer" class="table-wrapper"></div></div>
        </div>
        <div id="statusMessage" class="has-text-centered mt-2" role="status" aria-live="polite"></div>
    </section>
    
    <div class="modal" id="insightsModal"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Analysis</p><button class="delete" aria-label="close"></button></header><section class="modal-card-body" id="insightsResult"></section></div></div>

    <div id="pickerModal" class="picker-modal">
        <div class="picker-card">
            <div class="picker-header"><button id="pickerCancel">Cancel</button><button id="pickerDone">Done</button></div>
            <div class="picker-content"><div class="picker-wheels" id="pickerWheelsContainer"></div><div class="picker-selection-indicator"></div></div>
        </div>
    </div>

    <script>
        (function() {
            const CORS_PROXY = "https://api.allorigins.win/raw?url=";
            const LAST_TICKER_KEY = 'qualitystock_lastTicker';
            let allDates = [], allPrices = [], dates = [], prices = [];
            let trendChannel = null, fairValue = null;
            let iwquHoldings = [];
            let pickerCallback = null;

            let tickerInput, fetchButton, statusMessage, insightsModal, insightsResult,
                discountRateInput, terminalGrowthInput, fairValueInput, timePeriodSelector,
                pickerModal, pickerWheelsContainer, pickerCancel, pickerDone;

            document.addEventListener('DOMContentLoaded', () => {
                tickerInput = document.getElementById('tickerInput');
                fetchButton = document.getElementById('fetchButton');
                statusMessage = document.getElementById('statusMessage');
                insightsModal = document.getElementById('insightsModal');
                insightsResult = document.getElementById('insightsResult');
                discountRateInput = document.getElementById('discountRateInput');
                terminalGrowthInput = document.getElementById('terminalGrowthInput');
                fairValueInput = document.getElementById('fairValueInput');
                timePeriodSelector = document.getElementById('timePeriodSelector');
                pickerModal = document.getElementById('pickerModal');
                pickerWheelsContainer = document.getElementById('pickerWheelsContainer');
                pickerCancel = document.getElementById('pickerCancel');
                pickerDone = document.getElementById('pickerDone');

                fetchButton.addEventListener('click', fetchData);
                tickerInput.addEventListener('click', handleTickerPicker);
                discountRateInput.addEventListener('click', handleDiscountRatePicker);
                terminalGrowthInput.addEventListener('click', handleTerminalGrowthPicker);
                pickerCancel.addEventListener('click', hidePicker);
                pickerDone.addEventListener('click', handlePickerDone);
                pickerModal.addEventListener('click', (e) => { if (e.target === pickerModal) hidePicker(); });

                document.getElementById('qualityScreenButton').addEventListener('click', fetchQualityHoldings);
                document.getElementById('insightsButton').addEventListener('click', calculateAndShowInsights);
                document.getElementById('channelButton').addEventListener('click', () => { trendChannel = calculateTrendChannel(prices); processAndDraw(); });
                insightsModal.querySelector('.modal-background').addEventListener('click', () => insightsModal.classList.remove('is-active'));
                insightsModal.querySelector('.delete').addEventListener('click', () => insightsModal.classList.remove('is-active'));
                
                const settingsDropdown = document.getElementById('settingsDropdown');
                settingsDropdown.addEventListener('click', (event) => {
                    event.stopPropagation();
                    settingsDropdown.classList.toggle('is-active');
                });
                document.addEventListener('click', () => { settingsDropdown.classList.remove('is-active'); });
                
                setupPWA();
                const lastTicker = localStorage.getItem(LAST_TICKER_KEY);
                if (lastTicker) { tickerInput.value = lastTicker; }
                fetchData();
            });
            
            function showPicker(columnsData, targetInput, callback) {
                pickerWheelsContainer.innerHTML = '';
                columnsData.forEach(columnData => {
                    const wheel = document.createElement('div');
                    wheel.className = 'picker-wheel';
                    
                    const paddingDiv = '<div class="picker-item" style="height: 98px;"></div>';
                    wheel.innerHTML += paddingDiv;

                    columnData.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'picker-item';
                        itemDiv.textContent = item;
                        wheel.appendChild(itemDiv);
                    });

                    wheel.innerHTML += paddingDiv;
                    pickerWheelsContainer.appendChild(wheel);

                    let initialValue = targetInput.value;
                    const initialIndex = columnData.findIndex(item => item == initialValue);
                    
                    if (initialIndex !== -1) {
                        setTimeout(() => { wheel.scrollTop = initialIndex * 44; }, 0);
                    }
                });

                pickerCallback = callback;
                pickerModal.classList.add('is-active');
            }

            function hidePicker() {
                pickerModal.classList.remove('is-active');
                pickerCallback = null;
            }

            function handlePickerDone() {
                const wheels = pickerWheelsContainer.querySelectorAll('.picker-wheel');
                const selectedValues = [];

                wheels.forEach(wheel => {
                    const scroll_top = wheel.scrollTop;
                    const selectedIndex = Math.round(scroll_top / 44);
                    const selectedItem = wheel.querySelectorAll('.picker-item')[selectedIndex + 1];
                    selectedValues.push(selectedItem ? selectedItem.textContent : '');
                });

                if (pickerCallback) {
                    pickerCallback(selectedValues.join(''));
                }
                hidePicker();
            }

            async function handleTickerPicker() {
                if (iwquHoldings.length === 0) {
                    statusMessage.textContent = 'Loading quality stock list...';
                    try {
                        const url = 'https://www.ishares.com/uk/individual/en/products/270054/ishares-msci-world-quality-factor-ucits-etf/1506575576011.ajax?fileType=csv&fileName=IWQU_holdings&dataType=fund';
                        const proxyUrl = `${CORS_PROXY}${encodeURIComponent(url)}`;
                        const response = await fetch(proxyUrl);
                        const csvData = await response.text();
                        const lines = csvData.trim().split('\n');
                        const dataStartIndex = lines.findIndex(line => line.trim().toLowerCase().startsWith('ticker,'));
                        const holdingsData = lines.slice(dataStartIndex + 1);
                        
                        iwquHoldings = holdingsData.map(line => {
                            const columns = line.split(',');
                            const ticker = columns[0]?.replace(/"/g, '').split(' ')[0].trim();
                            return ticker ? `${ticker}.US` : null;
                        }).filter(Boolean);
                        statusMessage.textContent = 'Ticker list loaded.';
                    } catch (error) {
                        statusMessage.textContent = 'Error loading tickers.';
                        console.error("Error fetching holdings for picker:", error);
                        return;
                    }
                }
                
                showPicker([iwquHoldings], tickerInput, (selectedValue) => {
                    tickerInput.value = selectedValue;
                    fetchData();
                });
            }

            function handleDiscountRatePicker() {
                const rates = Array.from({length: 41}, (_, i) => (5 + i * 0.25).toFixed(2));
                showPicker([rates], discountRateInput, (selectedValue) => {
                    discountRateInput.value = selectedValue;
                    fetchData();
                });
            }

            function handleTerminalGrowthPicker() {
                const rates = Array.from({length: 21}, (_, i) => (1.5 + i * 0.05).toFixed(2));
                showPicker([rates], terminalGrowthInput, (selectedValue) => {
                    terminalGrowthInput.value = selectedValue;
                    fetchData();
                });
            }

            function setupPWA() { if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js').then(reg => console.log('SW registered'), err => console.log('SW registration failed: ', err)); }); } }
            
            async function fetchData() {
                trendChannel = null; fairValue = null; fairValueInput.value = '';
                const ticker = tickerInput.value.trim().toUpperCase();
                if (!ticker || ticker.includes("...")) { statusMessage.textContent = "Please select a ticker."; return; }
                statusMessage.textContent = `Fetching price data for ${ticker}...`;
                clearCharts();
                try {
                    const stooqUrl = `https://stooq.com/q/d/l/?s=${ticker}&i=w&c=1`;
                    const proxyUrl = `${CORS_PROXY}${encodeURIComponent(stooqUrl)}`;
                    const response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error(`Network error fetching price data: ${response.statusText}`);
                    const rawData = await response.text();
                    if (rawData.trim().startsWith('<') || !rawData.toUpperCase().includes('DATE')) throw new Error('Invalid price data format or ticker not found.');
                    const lines = rawData.trim().split('\n');
                    const headerLine = lines.shift(), delimiter = headerLine.includes(';') ? ';' : ',', headers = headerLine.split(delimiter).map(h => h.trim().toUpperCase());
                    const dateIndex = headers.indexOf('DATE'), closeIndex = headers.indexOf('CLOSE');
                    if (dateIndex === -1 || closeIndex === -1) throw new Error('Could not find "DATE" or "CLOSE" columns.');
                    allDates = [], allPrices = [];
                    lines.forEach(line => { const columns = line.split(delimiter); if (columns.length > Math.max(dateIndex, closeIndex)) { const dateStr = columns[dateIndex], closePrice = parseFloat(columns[closeIndex]); if (dateStr && !isNaN(closePrice)) { allDates.push(dateStr); allPrices.push(closePrice); } } });
                    if (allPrices.length === 0) throw new Error("No valid price data rows found.");
                    localStorage.setItem(LAST_TICKER_KEY, ticker);
                    await fetchAndCalculateFairValue();
                    processAndDraw();
                } catch (error) { statusMessage.textContent = `Error: ${error.message}`; console.error("Fetch error:", error); }
            }
            
            async function fetchAndCalculateFairValue() {
                const ticker = tickerInput.value.trim().toUpperCase().split('.')[0];
                if (!ticker) return;
                statusMessage.textContent = `Fetching fundamental data for ${ticker}...`;
                const targetUrl = `https://finviz.com/quote.ashx?t=${ticker}`;
                const proxyUrl = `${CORS_PROXY}${encodeURIComponent(targetUrl)}`;
                try {
                    const response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error(`Finviz Network Error: ${response.statusText}`);
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, "text/html");
                    const data = {};
                    doc.querySelectorAll('.snapshot-table2 td').forEach((cell, i) => { if (i % 2 === 0) { const key = cell.textContent.trim(); if (doc.querySelectorAll('.snapshot-table2 td')[i+1]) { data[key] = doc.querySelectorAll('.snapshot-table2 td')[i+1].textContent.trim(); } } });
                    const epsTTM = parseFloat(data['EPS (ttm)']);
                    const epsNext5Y = parseFloat(data['EPS next 5Y']?.replace('%', ''));
                    if (isNaN(epsTTM) || isNaN(epsNext5Y)) throw new Error("Could not find required EPS data from Finviz.");
                    const discountRate = parseFloat(discountRateInput.value) / 100;
                    const terminalGrowthRate = parseFloat(terminalGrowthInput.value) / 100;
                    const calculatedFV = calculateDCF(epsTTM, epsNext5Y / 100, terminalGrowthRate, discountRate);
                    fairValue = calculatedFV;
                    fairValueInput.value = fairValue.toFixed(2);
                    statusMessage.textContent = `Successfully calculated Fair Value: $${fairValue.toFixed(2)}`;
                } catch (error) { console.error(`Fair Value Calculation Error: ${error.message}`); statusMessage.textContent = `Could not calculate Fair Value. ${error.message}`; fairValue = null; fairValueInput.value = ''; }
            }

            function processAndDraw() { if (allPrices.length === 0) return; drawPriceChart(); drawMacdChart(); }
            function clearCharts() {
                const canvases = document.querySelectorAll('canvas');
                canvases.forEach(canvas => {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                });
            }
            function calculateDCF(eps, growthRate5Y, terminalGrowthRate, discountRate) { let pvSum = 0; let currentEps = eps; for (let i = 1; i <= 5; i++) { currentEps *= (1 + growthRate5Y); pvSum += currentEps / Math.pow(1 + discountRate, i); } const terminalEps = currentEps * (1 + terminalGrowthRate); const terminalValue = terminalEps / (discountRate - terminalGrowthRate); const pvTerminalValue = terminalValue / Math.pow(1 + discountRate, 5); return pvSum + pvTerminalValue; }
            
            function drawPriceChart() {
                const canvas = document.getElementById('priceChart');
                const ctx = canvas.getContext('2d');
                const container = canvas.parentElement;
                canvas.width = container.clientWidth * devicePixelRatio;
                canvas.height = container.clientHeight * devicePixelRatio;
                ctx.scale(devicePixelRatio, devicePixelRatio);
                // The rest of your detailed drawing logic...
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#fff';
                ctx.fillText(`Price Chart for ${tickerInput.value}`, 20, 20);
            }
            function drawMacdChart() {
                const canvas = document.getElementById('macdChart');
                const ctx = canvas.getContext('2d');
                const container = canvas.parentElement;
                canvas.width = container.clientWidth * devicePixelRatio;
                canvas.height = container.clientHeight * devicePixelRatio;
                ctx.scale(devicePixelRatio, devicePixelRatio);
                // The rest of your detailed drawing logic...
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#fff';
                ctx.fillText('MACD Chart', 20, 20);
            }
            function calculateAndShowInsights() { insightsModal.classList.add('is-active'); insightsResult.innerHTML = '<p>Insights analysis would be shown here.</p>'; }
            function fetchQualityHoldings() { insightsModal.classList.add('is-active'); insightsResult.innerHTML = '<p>List of top quality holdings would be shown here.</p>'; }
            function calculateTrendChannel(prices) { /* Your trend channel logic */ return null; }
        })();
    </script>
</body>
</html>