<!DOCTYPE html>
<html class="has-navbar-fixed-top is-dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>QualityStock Screener</title>
    
    <meta name="description" content="A quality stock screener and technical analysis tool.">
    <meta name="theme-color" content="#363636">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="QualityStock">

    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">

    <style>
        /* Base Theme */
        :root { --dark-bg-1: #1a1d21; --dark-bg-2: #272a2e; --dark-border: #444; --light-text: #f0f0f0; --dim-text: #a0a0a0; }
        html { background-color: var(--dark-bg-1); }
        body { background-color: var(--dark-bg-1); color: var(--light-text); }
        .navbar { background-color: var(--dark-bg-2); border-bottom: 1px solid var(--dark-border); }
        .navbar-item, .navbar-link { color: var(--light-text); cursor: pointer; }
        .navbar-link:not(.is-arrowless)::after { border-color: #3273dc; }
        .input, .select select { background-color: var(--dark-bg-1); border-color: var(--dark-border); color: var(--light-text); }
        .input::placeholder { color: var(--dim-text); }
        .label, .has-text-weight-bold { color: var(--light-text); }
        .modal-card-body { color: #3298dc; }

        /* Page Layout */
        html { height: 100svh; }
        body { display: flex; flex-direction: column; min-height: 100svh; }
        
        .page {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        #settingsPage {
            display: none; /* Hidden by default */
        }
        
        .page-nav { padding-top: env(safe-area-inset-top); }
        .page-content { flex-grow: 1; height: 1px; padding-bottom: env(safe-area-inset-bottom); }

        #appContainer { flex-grow: 1; display: flex; gap: 10px; flex-direction: column; }
        @media screen and (min-width: 769px) { #appContainer { flex-direction: row; } }
        #left-panel { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .chart-wrapper { background-color: var(--dark-bg-2); border-radius: 6px; position: relative; flex: 1 1 0; min-height: 0; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* Settings Page Specifics */
        .settings-field { max-width: 400px; margin-bottom: 1.5rem; }

    </style>
</head>
<body>

    <!-- PAGE 1: MAIN PAGE (CHARTS) -->
    <div id="mainPage" class="page">
        <nav class="navbar is-fixed-top page-nav" role="navigation" aria-label="main navigation">
            <div class="navbar-brand">
                <a class="navbar-item has-text-weight-bold" id="qualityScreenButton">Quality Screen</a>
                <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarBasicMenu"><span></span><span></span><span></span><span></span></a>
            </div>
            <div id="navbarBasicMenu" class="navbar-menu">
                <div class="navbar-start">
                    <div class="navbar-item">
                        <div class="field is-grouped">
                            <p class="control is-expanded"><input class="input" type="text" id="tickerInput" value="MSFT.US" placeholder="e.g., AAPL.US" aria-label="Ticker Symbol Input"></p>
                            <p class="control"><button id="fetchButton" class="button is-info" aria-label="Fetch stock data">Fetch</button></p>
                        </div>
                    </div>
                    <a class="navbar-item" id="goToSettingsButton">Settings</a>
                </div>
            </div>
        </nav>

        <section class="section page-content">
            <div id="appContainer">
                <div id="left-panel">
                    <div id="priceChartContainer" class="chart-wrapper">
                        <canvas id="priceChart"></canvas>
                    </div>
                    <div id="macdChartContainer" class="chart-wrapper">
                        <canvas id="macdChart"></canvas>
                    </div>
                </div>
            </div>
            <div id="statusMessage" class="has-text-centered mt-2" role="status" aria-live="polite"></div>
        </section>
    </div>

    <!-- PAGE 2: SETTINGS PAGE -->
    <div id="settingsPage" class="page">
        <nav class="navbar page-nav">
            <div class="navbar-brand">
                <a class="navbar-item" id="backButton">
                    < Back
                </a>
            </div>
            <div class="navbar-menu is-active">
                <div class="navbar-start">
                    <div class="navbar-item has-text-weight-bold">
                        Settings
                    </div>
                </div>
            </div>
        </nav>

        <section class="section page-content">
            <div class="container">
                <h2 class="title is-4 has-text-light">Calculations</h2>
                
                <div class="field settings-field">
                    <label class="label" for="discountRateInput">Discount Rate (%)</label>
                    <div class="control">
                        <input class="input" type="number" id="discountRateInput" value="9.5" step="0.1">
                    </div>
                </div>

                <div class="field settings-field">
                    <label class="label" for="terminalGrowthInput">Terminal Growth Rate (%)</label>
                    <div class="control">
                        <input class="input" type="number" id="terminalGrowthInput" value="2.5" step="0.1">
                    </div>
                </div>

                <hr>

                <h2 class="title is-4 has-text-light">Chart Display</h2>
                <div class="field settings-field">
                    <label class="label" for="timePeriodSelector">Default Time Period</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select id="timePeriodSelector">
                                <option value="all">All Time</option>
                                <option value="10yr">10 Years</option>
                                <option value="7yr">7 Years</option>
                                <option value="5yr" selected>5 Years</option>
                                <option value="3yr">3 Years</option>
                                <option value="1yr">1 Year</option>
                            </select>
                        </div>
                    </div>
                </div>

                <hr>
                
                <h2 class="title is-4 has-text-light">App Data</h2>
                <div class="field">
                    <div class="control">
                        <button class="button is-danger" id="deleteDataButton">Clear Saved Ticker & App Data</button>
                    </div>
                    <p class="help has-text-grey">This will clear the last viewed ticker and any other stored app settings.</p>
                </div>
                 <div id="settingsStatusMessage" class="has-text-centered mt-4" role="status"></div>
            </div>
        </section>
    </div>

    <!-- GLOBAL MODAL (Accessible from any page) -->
    <div class="modal" id="insightsModal"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Analysis</p><button class="delete" aria-label="close"></button></header><section class="modal-card-body" id="insightsResult"></section></div></div>

    <script>
        (function() {
            // --- CONSTANTS AND STATE ---
            const CORS_PROXY = "https://api.allorigins.win/raw?url=";
            const LAST_TICKER_KEY = 'qualitystock_lastTicker';
            const SETTINGS_KEY = 'qualitystock_settings';
            let allDates = [], allPrices = [], dates = [], prices = [];
            let trendChannel = null, fairValue = null;

            // --- DOM ELEMENT REFERENCES ---
            let mainPage, settingsPage, goToSettingsButton, backButton,
                tickerInput, fetchButton, statusMessage, settingsStatusMessage,
                insightsModal, insightsResult, qualityScreenButton,
                discountRateInput, terminalGrowthInput, timePeriodSelector,
                priceChartContainer, priceCanvas, priceCtx, macdChartContainer, macdCanvas, macdCtx,
                deleteDataButton;
                
            // --- PRIMARY EVENT LISTENER ---
            document.addEventListener('DOMContentLoaded', () => {
                // Assign all DOM elements
                mainPage = document.getElementById('mainPage');
                settingsPage = document.getElementById('settingsPage');
                goToSettingsButton = document.getElementById('goToSettingsButton');
                backButton = document.getElementById('backButton');
                tickerInput = document.getElementById('tickerInput');
                fetchButton = document.getElementById('fetchButton');
                statusMessage = document.getElementById('statusMessage');
                settingsStatusMessage = document.getElementById('settingsStatusMessage');
                insightsModal = document.getElementById('insightsModal');
                insightsResult = document.getElementById('insightsResult');
                qualityScreenButton = document.getElementById('qualityScreenButton');
                discountRateInput = document.getElementById('discountRateInput');
                terminalGrowthInput = document.getElementById('terminalGrowthInput');
                timePeriodSelector = document.getElementById('timePeriodSelector');
                priceChartContainer = document.getElementById('priceChartContainer');
                priceCanvas = document.getElementById('priceChart');
                priceCtx = priceCanvas.getContext('2d');
                macdChartContainer = document.getElementById('macdChartContainer');
                macdCanvas = document.getElementById('macdChart');
                macdCtx = macdCanvas.getContext('2d');
                deleteDataButton = document.getElementById('deleteDataButton');

                // --- EVENT LISTENERS ---
                // Page Navigation
                goToSettingsButton.addEventListener('click', () => {
                    mainPage.style.display = 'none';
                    settingsPage.style.display = 'flex';
                });
                backButton.addEventListener('click', () => {
                    mainPage.style.display = 'flex';
                    settingsPage.style.display = 'none';
                    fetchData(); // Re-fetch data in case settings changed
                });
                
                // Main Page Actions
                fetchButton.addEventListener('click', fetchData);
                tickerInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') fetchData(); });
                qualityScreenButton.addEventListener('click', fetchQualityHoldings);

                // Settings Page Actions
                deleteDataButton.addEventListener('click', () => {
                    if (confirm("Are you sure you want to delete all saved app data?")) {
                        localStorage.clear();
                        loadSettings(); // Reload default settings into UI
                        settingsStatusMessage.textContent = 'All data has been cleared.';
                        setTimeout(() => { settingsStatusMessage.textContent = ''; }, 3000);
                    }
                });
                discountRateInput.addEventListener('change', saveSettings);
                terminalGrowthInput.addEventListener('change', saveSettings);
                timePeriodSelector.addEventListener('change', saveSettings);

                // Burger Menu
                const burger = document.querySelector('.navbar-burger');
                const menu = document.getElementById(burger.dataset.target);
                burger.addEventListener('click', () => {
                    burger.classList.toggle('is-active');
                    menu.classList.toggle('is-active');
                });

                // --- INITIALIZATION ---
                setupPWA();
                loadSettings();
                const lastTicker = localStorage.getItem(LAST_TICKER_KEY);
                if (lastTicker) { tickerInput.value = lastTicker; }
                fetchData();
            });
            
            // --- SETTINGS MANAGEMENT ---
            function saveSettings() {
                const settings = {
                    discountRate: discountRateInput.value,
                    terminalGrowth: terminalGrowthInput.value,
                    timePeriod: timePeriodSelector.value
                };
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
                settingsStatusMessage.textContent = 'Settings saved.';
                setTimeout(() => { settingsStatusMessage.textContent = ''; }, 2000);
            }

            function loadSettings() {
                const savedSettings = localStorage.getItem(SETTINGS_KEY);
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    discountRateInput.value = settings.discountRate || '9.5';
                    terminalGrowthInput.value = settings.terminalGrowth || '2.5';
                    timePeriodSelector.value = settings.timePeriod || '5yr';
                } else {
                    // Load defaults if no settings saved
                    discountRateInput.value = '9.5';
                    terminalGrowthInput.value = '2.5';
                    timePeriodSelector.value = '5yr';
                }
            }
            
            // --- CORE APP LOGIC ---
            function setupPWA() { if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js').then(reg => console.log('SW registered'), err => console.log('SW registration failed: ', err)); }); } }
            
            async function fetchData() {
                fairValue = null;
                const ticker = tickerInput.value.trim().toUpperCase();
                if (!ticker) { statusMessage.textContent = "Please enter a ticker symbol."; return; }
                statusMessage.textContent = `Fetching data for ${ticker}...`;
                clearCharts();
                try {
                    const stooqUrl = `https://stooq.com/q/d/l/?s=${ticker}&i=w&c=1`;
                    const proxyUrl = `${CORS_PROXY}${encodeURIComponent(stooqUrl)}`;
                    const [priceResponse, fundamentalData] = await Promise.all([
                        fetch(proxyUrl),
                        fetchAndParseFundamentals(ticker.split('.')[0])
                    ]);

                    if (!priceResponse.ok) throw new Error(`Network error fetching price data: ${priceResponse.statusText}`);
                    const rawData = await priceResponse.text();
                    if (rawData.trim().startsWith('<') || !rawData.toUpperCase().includes('DATE')) throw new Error('Invalid price data or ticker not found.');
                    
                    // Parse price data
                    const lines = rawData.trim().split('\n');
                    const headerLine = lines.shift(), delimiter = headerLine.includes(';') ? ';' : ',', headers = headerLine.split(delimiter).map(h => h.trim().toUpperCase());
                    const dateIndex = headers.indexOf('DATE'), closeIndex = headers.indexOf('CLOSE');
                    if (dateIndex === -1 || closeIndex === -1) throw new Error('Could not find "DATE" or "CLOSE" columns.');
                    allDates = [], allPrices = [];
                    lines.forEach(line => { const columns = line.split(delimiter); if (columns.length > Math.max(dateIndex, closeIndex)) { const dateStr = columns[dateIndex], closePrice = parseFloat(columns[closeIndex]); if (dateStr && !isNaN(closePrice)) { allDates.push(dateStr); allPrices.push(closePrice); } } });
                    if (allPrices.length === 0) throw new Error("No valid price data rows found.");
                    
                    // Calculate Fair Value with fetched fundamentals
                    if (fundamentalData) {
                        const discountRate = parseFloat(discountRateInput.value) / 100;
                        const terminalGrowthRate = parseFloat(terminalGrowthInput.value) / 100;
                        fairValue = calculateDCF(fundamentalData.epsTTM, fundamentalData.epsNext5Y / 100, terminalGrowthRate, discountRate);
                        document.getElementById('fairValueInput').value = fairValue.toFixed(2);
                    }
                    
                    localStorage.setItem(LAST_TICKER_KEY, ticker);
                    statusMessage.textContent = `Displaying ${ticker}`;
                    processAndDraw();

                } catch (error) { statusMessage.textContent = `Error: ${error.message}`; console.error("Fetch error:", error); }
            }
            
            async function fetchAndParseFundamentals(tickerSymbol) {
                 if (!tickerSymbol) return null;
                try {
                    const targetUrl = `https://finviz.com/quote.ashx?t=${tickerSymbol}`;
                    const proxyUrl = `${CORS_PROXY}${encodeURIComponent(targetUrl)}`;
                    const response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error(`Finviz Network Error`);
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, "text/html");
                    const data = {};
                    doc.querySelectorAll('.snapshot-table2 td').forEach((cell, i) => { if (i % 2 === 0) { const key = cell.textContent.trim(); if (doc.querySelectorAll('.snapshot-table2 td')[i+1]) { data[key] = doc.querySelectorAll('.snapshot-table2 td')[i+1].textContent.trim(); } } });
                    const epsTTM = parseFloat(data['EPS (ttm)']);
                    const epsNext5Y = parseFloat(data['EPS next 5Y']?.replace('%', ''));
                    if (isNaN(epsTTM) || isNaN(epsNext5Y)) return null;
                    return { epsTTM, epsNext5Y };
                } catch (error) {
                    console.error(`Fundamental data error for ${tickerSymbol}:`, error);
                    return null;
                }
            }

            function processAndDraw() { if (allPrices.length === 0) return; const fastPeriod = 10, slowPeriod = 20; const full = { fastEma: calculateEMA(allPrices, fastPeriod), slowEma: calculateEMA(allPrices, slowPeriod), ...calculateMACD(allPrices) }; const startIndex = getFilterStartIndex(); dates = allDates.slice(startIndex); prices = allPrices.slice(startIndex); const sliced = { fastEma: full.fastEma.slice(startIndex), slowEma: full.slowEma.slice(startIndex), macdLine: full.macdLine.slice(startIndex), signalLine: full.signalLine.slice(startIndex), histogram: full.histogram.slice(startIndex) }; if (prices.length === 0) { clearCharts(); statusMessage.textContent = "No data for selected time period."; return; } drawPriceChart(sliced, fastPeriod, slowPeriod); drawMacdChart(sliced); }
            
            // ... The rest of the functions (calculateDCF, drawPriceChart, etc.) go here ...
            // (omitted for brevity, but they are the same as the previous versions)
             function clearCharts() {
                if(priceCtx) priceCtx.clearRect(0, 0, priceCanvas.width, priceCanvas.height);
                if(macdCtx) macdCtx.clearRect(0, 0, macdCanvas.width, macdCanvas.height);
            }
            function calculateDCF(eps, growthRate5Y, terminalGrowthRate, discountRate) { let pvSum = 0; let currentEps = eps; for (let i = 1; i <= 5; i++) { currentEps *= (1 + growthRate5Y); pvSum += currentEps / Math.pow(1 + discountRate, i); } const terminalEps = currentEps * (1 + terminalGrowthRate); const terminalValue = terminalEps / (discountRate - terminalGrowthRate); const pvTerminalValue = terminalValue / Math.pow(1 + discountRate, 5); return pvSum + pvTerminalValue; }
            function getFilterStartIndex() { const period = timePeriodSelector.value, totalPoints = allDates.length; const weeksInYear = 52; if (period === 'all') return 0; if (period === '10yr') return Math.max(0, totalPoints - (10 * weeksInYear)); if (period === '7yr') return Math.max(0, totalPoints - (7 * weeksInYear)); if (period === '5yr') return Math.max(0, totalPoints - (5 * weeksInYear)); if (period === '3yr') return Math.max(0, totalPoints - (3 * weeksInYear)); if (period === '1yr') return Math.max(0, totalPoints - (1 * weeksInYear)); return 0; }
            function calculateEMA(data, period) { if (!data || data.length < period) return new Array(data.length).fill(null); const k = 2 / (period + 1); const ema = new Array(data.length).fill(null); let sum = 0; for (let i = 0; i < period; i++) sum += data[i]; ema[period - 1] = sum / period; for (let i = period; i < data.length; i++) { if (ema[i-1] !== null) { ema[i] = (data[i] * k) + (ema[i - 1] * (1 - k)); } } return ema; }
            function calculateMACD(data, p12=12, p26=26, pSignal=9) { const ema12 = calculateEMA(data, p12); const ema26 = calculateEMA(data, p26); const macdLine = ema26.map((v, i) => v !== null && ema12[i] !== null ? ema12[i] - v : null); const signalLine = calculateEMA(macdLine, pSignal); const histogram = signalLine.map((v, i) => v !== null && macdLine[i] !== null ? macdLine[i] - v : null); return { macdLine, signalLine, histogram }; }
            function drawPriceChart(slicedData, fastPeriod, slowPeriod) { /* ... Your full drawing logic ... */ }
            function drawMacdChart(slicedData) { /* ... Your full drawing logic ... */ }
            async function fetchQualityHoldings() { /* ... Your full fetching logic ... */ }
            function calculateAndShowInsights() { /* ... Your full insights logic ... */ }

        })();
    </script>
</body>
</html>