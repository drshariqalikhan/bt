<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>QualityStock Screener</title>
    
    <meta name="theme-color" content="#1a1d21">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="QualityStock">

    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">

    <style>
        :root { --dark-bg-1: #1a1d21; --dark-bg-2: #272a2e; --dark-border: #444; --light-text: #f0f0f0; --dim-text: #a0a0a0; }
        html { background-color: var(--dark-bg-1); height: 100svh; }
        body { background-color: var(--dark-bg-1); color: var(--light-text); display: flex; flex-direction: column; height: 100%; margin: 0; }
        .navbar { background-color: var(--dark-bg-2); border-bottom: 1px solid var(--dark-border); }
        .navbar-item, .navbar-link { color: var(--light-text); cursor: pointer; }
        .navbar-burger span { background-color: var(--light-text); }
        .input, .select select { background-color: var(--dark-bg-1); border-color: var(--dark-border); color: var(--light-text); }
        .input::placeholder { color: var(--dim-text); }
        .label { color: var(--light-text); }

        .page { display: flex; flex-direction: column; height: 100%; width: 100%; }
        #settingsPage { display: none; }
        .page-nav { padding-top: env(safe-area-inset-top); flex-shrink: 0; }
        .page-content { flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: env(safe-area-inset-bottom); }

        #appContainer { display: flex; flex-direction: column; gap: 1rem; height: 100%; padding: 1rem; }
        .chart-wrapper { background-color: var(--dark-bg-2); border-radius: 6px; flex: 1; position: relative; min-height: 200px; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        .settings-container { padding: 1.5rem; }
        .settings-field { max-width: 400px; margin-bottom: 1.5rem; }
    </style>
</head>
<body>

    <!-- PAGE 1: MAIN PAGE (CHARTS) -->
    <div id="mainPage" class="page">
        <nav class="navbar page-nav" role="navigation" aria-label="main navigation">
            <div class="navbar-brand">
                <a class="navbar-item has-text-weight-bold">Quality Screen</a>
                <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarBasicMenu"><span></span><span></span><span></span></a>
            </div>
            <div id="navbarBasicMenu" class="navbar-menu">
                <div class="navbar-start">
                    <div class="navbar-item">
                        <div class="field is-grouped">
                            <p class="control is-expanded"><input class="input" type="text" id="tickerInput" value="MSFT.US" placeholder="e.g., AAPL.US"></p>
                            <p class="control"><button id="fetchButton" class="button is-info">Fetch</button></p>
                        </div>
                    </div>
                    <a class="navbar-item" id="goToSettingsButton">Settings</a>
                </div>
            </div>
        </nav>

        <main class="page-content">
            <div id="appContainer">
                <div id="priceChartWrapper" class="chart-wrapper"><canvas id="priceChart"></canvas></div>
                <div id="macdChartWrapper" class="chart-wrapper"><canvas id="macdChart"></canvas></div>
                <div id="statusMessage" class="has-text-centered" role="status"></div>
            </div>
        </main>
    </div>

    <!-- PAGE 2: SETTINGS PAGE -->
    <div id="settingsPage" class="page">
        <nav class="navbar page-nav">
            <div class="navbar-brand"><a class="navbar-item" id="backButton">< Back</a></div>
            <div class="navbar-menu is-active"><div class="navbar-start"><div class="navbar-item has-text-weight-bold">Settings</div></div></div>
        </nav>
        <main class="page-content">
            <div class="settings-container">
                <h2 class="title is-4 has-text-light">DCF Calculation</h2>
                <div class="field settings-field">
                    <label class="label" for="discountRateInput">Discount Rate (%)</label>
                    <div class="control"><input class="input" type="number" id="discountRateInput" value="9.5" step="0.1"></div>
                </div>
                <div class="field settings-field">
                    <label class="label" for="terminalGrowthInput">Terminal Growth Rate (%)</label>
                    <div class="control"><input class="input" type="number" id="terminalGrowthInput" value="2.5" step="0.1"></div>
                </div>
                <div class="field settings-field">
                    <label class="label" for="fairValueInput">Last Calculated Fair Value</label>
                    <div class="control"><input class="input" type="text" id="fairValueInput" placeholder="N/A" readonly></div>
                </div>
                <hr style="background-color: var(--dark-border);">
                <h2 class="title is-4 has-text-light">Chart Display</h2>
                <div class="field settings-field">
                    <label class="label" for="timePeriodSelector">Time Period</label>
                    <div class="control"><div class="select is-fullwidth"><select id="timePeriodSelector"><option value="all">All Time</option><option value="10yr">10 Years</option><option value="5yr" selected>5 Years</option><option value="1yr">1 Year</option></select></div></div>
                </div>
                <hr style="background-color: var(--dark-border);">
                <h2 class="title is-4 has-text-light">App Data</h2>
                <div class="field">
                    <div class="control"><button class="button is-danger" id="deleteDataButton">Clear All Saved Data</button></div>
                    <p class="help has-text-grey">This will clear the last viewed ticker and any saved settings.</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        (function() {
            // --- SECTION 1: CONSTANTS AND STATE ---
            const CORS_PROXY = "https://api.allorigins.win/raw?url=";
            const LAST_TICKER_KEY = 'qualitystock_lastTicker';
            const SETTINGS_KEY = 'qualitystock_settings';
            let allDates = [], allPrices = [];
            let fairValue = null;

            // --- SECTION 2: DOM ELEMENT REFERENCES ---
            let mainPage, settingsPage, goToSettingsButton, backButton,
                tickerInput, fetchButton, timePeriodSelector,
                priceCanvas, priceCtx, macdCanvas, macdCtx, statusMessage,
                deleteDataButton, discountRateInput, terminalGrowthInput, fairValueInput;

            // --- SECTION 3: PRIMARY EVENT LISTENER ---
            document.addEventListener('DOMContentLoaded', () => {
                // Assign references
                mainPage = document.getElementById('mainPage');
                settingsPage = document.getElementById('settingsPage');
                goToSettingsButton = document.getElementById('goToSettingsButton');
                backButton = document.getElementById('backButton');
                tickerInput = document.getElementById('tickerInput');
                fetchButton = document.getElementById('fetchButton');
                timePeriodSelector = document.getElementById('timePeriodSelector');
                priceCanvas = document.getElementById('priceChart');
                priceCtx = priceCanvas.getContext('2d');
                macdCanvas = document.getElementById('macdChart');
                macdCtx = macdCanvas.getContext('2d');
                statusMessage = document.getElementById('statusMessage');
                deleteDataButton = document.getElementById('deleteDataButton');
                discountRateInput = document.getElementById('discountRateInput');
                terminalGrowthInput = document.getElementById('terminalGrowthInput');
                fairValueInput = document.getElementById('fairValueInput');

                // Page Navigation Listeners
                goToSettingsButton.addEventListener('click', () => {
                    mainPage.style.display = 'none';
                    settingsPage.style.display = 'flex';
                    fairValueInput.value = fairValue ? `$${fairValue.toFixed(2)}` : 'N/A';
                });
                backButton.addEventListener('click', () => {
                    mainPage.style.display = 'flex';
                    settingsPage.style.display = 'none';
                    fetchData();
                });
                
                const burger = document.querySelector('.navbar-burger');
                const menu = document.getElementById(burger.dataset.target);
                burger.addEventListener('click', () => { burger.classList.toggle('is-active'); menu.classList.toggle('is-active'); });
                
                fetchButton.addEventListener('click', fetchData);
                tickerInput.addEventListener('keypress', e => { if (e.key === 'Enter') fetchData(); });
                deleteDataButton.addEventListener('click', () => {
                    if (confirm("Are you sure? This will clear all saved app data.")) {
                        localStorage.clear();
                        loadSettings();
                        alert("Cleared saved data.");
                    }
                });
                discountRateInput.addEventListener('change', saveSettings);
                terminalGrowthInput.addEventListener('change', saveSettings);
                timePeriodSelector.addEventListener('change', saveSettings);

                // --- App Initialization ---
                loadSettings();
                const lastTicker = localStorage.getItem(LAST_TICKER_KEY);
                if (lastTicker) { tickerInput.value = lastTicker; }
                fetchData();
            });
            
            // --- SECTION 4: SETTINGS MANAGEMENT ---
            function saveSettings() {
                const settings = {
                    discountRate: discountRateInput.value,
                    terminalGrowth: terminalGrowthInput.value,
                    timePeriod: timePeriodSelector.value
                };
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
                // If on the main page, redraw immediately after settings change
                if (mainPage.style.display !== 'none') {
                    processAndDraw();
                }
            }
            function loadSettings() {
                const savedSettings = localStorage.getItem(SETTINGS_KEY);
                const defaults = { discountRate: '9.5', terminalGrowth: '2.5', timePeriod: '5yr' };
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    discountRateInput.value = settings.discountRate || defaults.discountRate;
                    terminalGrowthInput.value = settings.terminalGrowth || defaults.terminalGrowth;
                    timePeriodSelector.value = settings.timePeriod || defaults.timePeriod;
                } else {
                    discountRateInput.value = defaults.discountRate;
                    terminalGrowthInput.value = defaults.terminalGrowth;
                    timePeriodSelector.value = defaults.timePeriod;
                }
            }
            
            // --- SECTION 5: CORE LOGIC (DATA FETCHING & PROCESSING) ---
            async function fetchData() {
                fairValue = null;
                const ticker = tickerInput.value.trim().toUpperCase();
                if (!ticker) { statusMessage.textContent = "Please enter a ticker symbol."; return; }
                statusMessage.textContent = `Fetching data for ${ticker}...`;
                clearCharts();
                try {
                    const [priceData, fundamentalData] = await Promise.all([
                        fetchPriceData(ticker),
                        fetchAndParseFundamentals(ticker.split('.')[0])
                    ]);
                    allDates = priceData.dates;
                    allPrices = priceData.prices;
                    if (fundamentalData) {
                        const discountRate = parseFloat(discountRateInput.value) / 100;
                        const terminalGrowthRate = parseFloat(terminalGrowthInput.value) / 100;
                        if (!isNaN(discountRate) && !isNaN(terminalGrowthRate)) {
                             fairValue = calculateDCF(fundamentalData.epsTTM, fundamentalData.epsNext5Y / 100, terminalGrowthRate, discountRate);
                        }
                    }
                    localStorage.setItem(LAST_TICKER_KEY, ticker);
                    statusMessage.textContent = `Displaying ${ticker}`;
                    processAndDraw();
                } catch (error) { statusMessage.textContent = `Error: ${error.message}`; console.error("Fetch error:", error); }
            }
            
            async function fetchPriceData(ticker) {
                const stooqUrl = `https://stooq.com/q/d/l/?s=${ticker}&i=w&c=1`;
                const proxyUrl = `${CORS_PROXY}${encodeURIComponent(stooqUrl)}`;
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`Network error fetching price data`);
                const rawData = await response.text();
                if (rawData.trim().startsWith('<') || !rawData.toUpperCase().includes('DATE')) throw new Error('Invalid price data or ticker not found.');
                const lines = rawData.trim().split('\n');
                const headerLine = lines.shift(), delimiter = headerLine.includes(';') ? ';' : ',', headers = headerLine.split(delimiter).map(h => h.trim().toUpperCase());
                const dateIndex = headers.indexOf('DATE'), closeIndex = headers.indexOf('CLOSE');
                if (dateIndex === -1 || closeIndex === -1) throw new Error('Could not parse price data columns.');
                const dates = [], prices = [];
                lines.forEach(line => { const cols = line.split(delimiter); if (cols.length > Math.max(dateIndex, closeIndex)) { const dateStr = cols[dateIndex], closePrice = parseFloat(cols[closeIndex]); if (dateStr && !isNaN(closePrice)) { dates.push(dateStr); prices.push(closePrice); } } });
                if (prices.length === 0) throw new Error("No valid price data rows found.");
                return { dates, prices };
            }

            async function fetchAndParseFundamentals(tickerSymbol) {
                 if (!tickerSymbol) return null;
                try {
                    const targetUrl = `https://finviz.com/quote.ashx?t=${tickerSymbol}`;
                    const proxyUrl = `${CORS_PROXY}${encodeURIComponent(targetUrl)}`;
                    const response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error(`Finviz network error`);
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, "text/html");
                    const data = {};
                    doc.querySelectorAll('.snapshot-table2 td').forEach((cell, i) => { if (i % 2 === 0) { const key = cell.textContent.trim(); if (doc.querySelectorAll('.snapshot-table2 td')[i+1]) { data[key] = doc.querySelectorAll('.snapshot-table2 td')[i+1].textContent.trim(); } } });
                    const epsTTM = parseFloat(data['EPS (ttm)']);
                    const epsNext5Y = parseFloat(data['EPS next 5Y']?.replace('%', ''));
                    if (isNaN(epsTTM) || isNaN(epsNext5Y)) return null;
                    return { epsTTM, epsNext5Y };
                } catch (error) { console.error(`Fundamental data error for ${tickerSymbol}:`, error); return null; }
            }

            function processAndDraw() {
                if (allPrices.length === 0) return;
                const fastPeriod = 10, slowPeriod = 20;
                const full = {
                    fastEma: calculateEMA(allPrices, fastPeriod),
                    slowEma: calculateEMA(allPrices, slowPeriod),
                    sma50: calculateSMA(allPrices, 50),   // --- NEW ---
                    sma100: calculateSMA(allPrices, 100), // --- NEW ---
                    ...calculateMACD(allPrices)
                };
                const startIndex = getFilterStartIndex();
                const dates = allDates.slice(startIndex), prices = allPrices.slice(startIndex);
                const sliced = {
                    fastEma: full.fastEma.slice(startIndex),
                    slowEma: full.slowEma.slice(startIndex),
                    sma50: full.sma50.slice(startIndex),   // --- NEW ---
                    sma100: full.sma100.slice(startIndex), // --- NEW ---
                    macdLine: full.macdLine.slice(startIndex),
                    signalLine: full.signalLine.slice(startIndex),
                    histogram: full.histogram.slice(startIndex)
                };
                if (prices.length === 0) { clearCharts(); statusMessage.textContent = "No data for selected time period."; return; }
                drawPriceChart(dates, prices, sliced, fastPeriod, slowPeriod);
                drawMacdChart(dates, prices, sliced);
            }

            // --- SECTION 6: CALCULATION & CHARTING ---
            function calculateDCF(eps, growthRate5Y, terminalGrowthRate, discountRate) { let pvSum = 0; let currentEps = eps; for (let i = 1; i <= 5; i++) { currentEps *= (1 + growthRate5Y); pvSum += currentEps / Math.pow(1 + discountRate, i); } const terminalEps = currentEps * (1 + terminalGrowthRate); const terminalValue = terminalEps / (discountRate - terminalGrowthRate); const pvTerminalValue = terminalValue / Math.pow(1 + discountRate, 5); return pvSum + pvTerminalValue; }
            function getFilterStartIndex() { const period = timePeriodSelector.value; const totalPoints = allDates.length; const weeksInYear = 52; if (period === 'all') return 0; if (period === '10yr') return Math.max(0, totalPoints - (10 * weeksInYear)); if (period === '5yr') return Math.max(0, totalPoints - (5 * weeksInYear)); if (period === '1yr') return Math.max(0, totalPoints - (1 * weeksInYear)); return 0; }
            
            // --- NEW: SMA Calculation Function ---
            function calculateSMA(data, period) {
                if (!data || data.length < period) return new Array(data.length).fill(null);
                const sma = new Array(data.length).fill(null);
                let sum = 0;
                for (let i = 0; i < period; i++) sum += data[i];
                sma[period - 1] = sum / period;
                for (let i = period; i < data.length; i++) {
                    sum = sum - data[i - period] + data[i];
                    sma[i] = sum / period;
                }
                return sma;
            }

            function calculateEMA(data, period) { if (!data || data.length < period) return new Array(data.length).fill(null); const k = 2 / (period + 1); const ema = new Array(data.length).fill(null); let sum = 0; for (let i = 0; i < period; i++) sum += data[i]; ema[period - 1] = sum / period; for (let i = period; i < data.length; i++) { if (ema[i-1] !== null) ema[i] = (data[i] * k) + (ema[i - 1] * (1 - k)); } return ema; }
            function calculateMACD(data, p12=12, p26=26, pSignal=9) { const ema12 = calculateEMA(data, p12); const ema26 = calculateEMA(data, p26); const macdLine = ema26.map((v, i) => v !== null && ema12[i] !== null ? ema12[i] - v : null); const signalLine = calculateEMA(macdLine, pSignal); const histogram = signalLine.map((v, i) => v !== null && macdLine[i] !== null ? macdLine[i] - v : null); return { macdLine, signalLine, histogram }; }
            function clearCharts() { priceCtx.clearRect(0, 0, priceCanvas.width, priceCanvas.height); macdCtx.clearRect(0, 0, macdCanvas.width, macdCanvas.height); }

            const drawLine = (ctx, data, mapX, mapY, color, lineWidth = 1.5) => { ctx.beginPath(); ctx.lineWidth = lineWidth; ctx.strokeStyle = color; let first = true; data.forEach((val, i) => { if (val !== null) { const x = mapX(i); const y = mapY(val); if (first) { ctx.moveTo(x, y); first = false; } else { ctx.lineTo(x, y); } } }); ctx.stroke(); };
            
            function drawPriceChart(dates, prices, slicedData, fastPeriod, slowPeriod) {
                const { fastEma, slowEma, sma50, sma100 } = slicedData; // --- NEW: Destructure SMAs
                const container = priceCanvas.parentElement;
                const w = container.clientWidth, h = container.clientHeight;
                if (w <= 0 || h <= 0) return;

                priceCanvas.width = w * devicePixelRatio;
                priceCanvas.height = h * devicePixelRatio;
                priceCtx.scale(devicePixelRatio, devicePixelRatio);
                priceCtx.clearRect(0, 0, w, h);

                // --- NEW: Add SMAs to visible data for scaling ---
                let allVisibleData = [...prices, ...fastEma.filter(v=>v), ...slowEma.filter(v=>v), ...sma50.filter(v=>v), ...sma100.filter(v=>v)];
                if (fairValue) allVisibleData.push(fairValue);
                
                const minY = Math.min(...allVisibleData), maxY = Math.max(...allVisibleData);
                const margin = { top: 20, right: 50, bottom: 40, left: 50 };
                const chartW = w - margin.left - margin.right, chartH = h - margin.top - margin.bottom;
                const mapX = (i) => margin.left + (prices.length > 1 ? (i / (prices.length - 1)) * chartW : chartW / 2);
                const mapY = (v) => h - margin.bottom - ((v - minY) / (maxY - minY)) * chartH;
                
                priceCtx.font = "12px sans-serif"; priceCtx.textAlign = 'right'; priceCtx.fillStyle = '#a0a0a0';
                for (let i = 0; i <= 5; i++) {
                    const val = minY + (i / 5) * (maxY - minY); const y = mapY(val);
                    priceCtx.beginPath(); priceCtx.strokeStyle = '#444'; priceCtx.lineWidth = 0.5;
                    priceCtx.moveTo(margin.left, y); priceCtx.lineTo(w - margin.right, y);
                    priceCtx.stroke(); priceCtx.fillText(val.toFixed(2), margin.left - 8, y + 4);
                }
                const xTickStep = Math.max(1, Math.floor(prices.length / Math.floor(chartW / 100)));
                for (let i = 0; i < prices.length; i += xTickStep) { priceCtx.textAlign = 'center'; priceCtx.fillText(dates[i], mapX(i), h - margin.bottom + 20); }

                drawLine(priceCtx, prices, mapX, mapY, '#a0a0a0', 1.5);
                drawLine(priceCtx, fastEma, mapX, mapY, '#3273dc');
                drawLine(priceCtx, slowEma, mapX, mapY, '#23d160');
                drawLine(priceCtx, sma50, mapX, mapY, '#ff9800');   // --- NEW ---
                drawLine(priceCtx, sma100, mapX, mapY, '#c56bf0'); // --- NEW ---

                if (fairValue !== null && fairValue >= minY && fairValue <= maxY) {
                    const y = mapY(fairValue);
                    priceCtx.beginPath(); priceCtx.setLineDash([4, 4]); priceCtx.strokeStyle = '#ffd700'; priceCtx.lineWidth = 1.5;
                    priceCtx.moveTo(margin.left, y); priceCtx.lineTo(w - margin.right, y);
                    priceCtx.stroke(); priceCtx.setLineDash([]);
                    priceCtx.font = "12px sans-serif"; priceCtx.fillStyle = '#ffd700'; priceCtx.textAlign = 'left';
                    priceCtx.fillText('Fair Value', w - margin.right + 5, y + 4);
                }

                const legX = margin.left + 10, legY = margin.top + 10, sp = 18;
                priceCtx.font = "14px sans-serif"; priceCtx.textAlign = 'left';
                priceCtx.fillStyle = '#a0a0a0'; priceCtx.fillText('Price', legX, legY);
                priceCtx.fillStyle = '#3273dc'; priceCtx.fillText(`Fast EMA (${fastPeriod})`, legX, legY + sp);
                priceCtx.fillStyle = '#23d160'; priceCtx.fillText(`Slow EMA (${slowPeriod})`, legX, legY + sp * 2);
                priceCtx.fillStyle = '#ff9800'; priceCtx.fillText('50-week SMA', legX, legY + sp * 3);   // --- NEW ---
                priceCtx.fillStyle = '#c56bf0'; priceCtx.fillText('100-week SMA', legX, legY + sp * 4); // --- NEW ---
            }

            function drawMacdChart(dates, prices, slicedData) {
                const { macdLine, signalLine, histogram } = slicedData;
                const container = macdCanvas.parentElement;
                const w = container.clientWidth, h = container.clientHeight;
                if (w <= 0 || h <= 0) return;
                
                macdCanvas.width = w * devicePixelRatio; macdCanvas.height = h * devicePixelRatio;
                macdCtx.scale(devicePixelRatio, devicePixelRatio);
                macdCtx.clearRect(0, 0, w, h);

                const allVisibleData = [...macdLine.filter(v=>v), ...signalLine.filter(v=>v), ...histogram.filter(v=>v)];
                if (allVisibleData.length === 0) return;
                const minY = Math.min(...allVisibleData), maxY = Math.max(...allVisibleData);
                const margin = { top: 20, right: 50, bottom: 40, left: 50 };
                const chartW = w - margin.left - margin.right, chartH = h - margin.top - margin.bottom;
                const mapX = (i) => margin.left + (prices.length > 1 ? (i / (prices.length - 1)) * chartW : chartW / 2);
                const mapY = (v) => h - margin.bottom - ((v - minY) / (maxY - minY)) * chartH;

                const yZero = mapY(0);
                macdCtx.beginPath(); macdCtx.strokeStyle = '#a0a0a0'; macdCtx.lineWidth = 1;
                macdCtx.moveTo(margin.left, yZero); macdCtx.lineTo(w - margin.right, yZero);
                macdCtx.stroke();

                const barW = Math.max(1, chartW / prices.length * 0.8);
                for(let i = 0; i < histogram.length; i++) {
                    if(histogram[i] !== null) {
                        const x = mapX(i) - barW / 2;
                        const y = mapY(histogram[i]);
                        macdCtx.fillStyle = histogram[i] > 0 ? 'rgba(35, 209, 96, 0.7)' : 'rgba(255, 56, 96, 0.7)';
                        macdCtx.fillRect(x, y, barW, yZero - y);
                    }
                }
                drawLine(macdCtx, macdLine, mapX, mapY, '#007bff');
                drawLine(macdCtx, signalLine, mapX, mapY, '#fd7e14');

                const legX = margin.left + 10, legY = margin.top + 10, sp = 18;
                macdCtx.font = "14px sans-serif"; macdCtx.textAlign = 'left';
                macdCtx.fillStyle = '#007bff'; macdCtx.fillText('MACD Line', legX, legY);
                macdCtx.fillStyle = '#fd7e14'; macdCtx.fillText('Signal Line', legX, legY + sp);
            }
        })();
    </script>
</body>
</html>